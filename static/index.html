<!doctype html>
<html>
<head>
    <title>Sports DJ</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--Import Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <meta property="og:title" content="Sports DJ"/>
    <meta property="og:description"
          content="Visualizing workout based music data"/>
    <meta property="og:image" content="placeholder"/>

    <link rel="icon" type="image/x-icon" href="assets/ico/favicon.ico?v=2">
    <script src="https://use.fontawesome.com/287f0668e1.js"></script>
    <link href="https://use.fontawesome.com/287f0668e1.css" media="all" rel="stylesheet">
    <style type="text/css">
        #login, #loggedin, #submitPlaylistForm, #submit-bmi-container {
            display: none;
        }
    </style>
    <div>
        <center><img src="assets/png/sportsdj.png"></center>
    </div>

</head>

<body class="page">
<div class="container">
    <div id="login">
        <br>
        <center>
            <div class="container-fluid-landing">
                <div id="blurb">Be your own workout DJ!<br>Log in with your Spotify account
                    to select a playlist and analyze how well it fits specific exercises.
                </div>
                <br>
                <br><a href="/api/login" class="text-center btn" id="spotify-button">Log in with <i
                    class="fa fa-spotify" aria-hidden="true"></i>
                Spotify</a>
            </div>
        </center>
    </div>
</div>
<div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>
    <button hidden data-toggle="collapse" data-target="#collapse-div">Collapsible</button>
    <div class="collapse" id="collapse-div">
        <button hidden class=" btn btn-default" id="obtain-new-token">Obtain new token using the refresh token
        </button>
    </div>
    <br>
    <div class="row" id="buttonsRow">
        <div id="viewPlaylistButton" class="col-sm">
            <button type="button" class="btn btn-success" id="viewButton">View Playlists</button>
        </div>
        <div id="createPlaylistButton" class="col-sm">
            <button type="button" class="btn btn-success" id="createButton">Create Playlist</button>
        </div>
    </div>
    <br>

</div> <!-- end of loggedin -->

<div id="submitPlaylistForm">
    <div class="row">

        <div class="form-group">
        <label class="control-label col-sm" for="exercisetype">Exercise Type</label><br>
        <select id="selected-exercise-type" class="semi-square green" title="Exercise Type">            <option value="Strength">Strength</option>
            <option value="Cardio">Cardio</option>
            <option value="Yoga">Yoga</option>
        </select>
        </div>
        <div class="form-group">
            <label class="control-label col-sm" for="maxNumSongs">Number of Songs</label>
                <input type="number" class="form-control" id="maxNumSongs" placeholder="Enter Number of Songs"
                       name="maxNumSongs">
        </div>
        <div class="form-group">
            <label class="control-label col-sm" for="newPlaylistName">Playlist Name</label>
                <input type="text" class="form-control" id="newPlaylistName" placeholder="Enter Playlist Name"
                       name="newPlaylistName">
        </div>
        <div class="form-group">
            <label class="control-label col-sm" for="genPlaylist">Generate Playlist!</label>
            <div id="subbutton">
                <button class="btn btn-success" id="create-playlist-button">Submit</button>
            </div>
        </div>
    </div>
</div>

<div id="submit-bmi-container" class="container">
    <br>
    <center>
        <div class="container-fluid-landing">
            <br>
            <input id="user-height" placeholder="height (inches)" type="number">
            <input id="user-weight" placeholder="weight (pounds)" type="number">
            <a class="text-center btn btn btn-success" id="submit-bmi">
                Submit
            </a>
        </div>
    </center>
</div>

<script id="oauth-template" type="text/x-handlebars-template">
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>
    (function () {
        var authResponse;

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');
        var params = getHashParams();
        var accessToken = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        var userId;
        let userProfile;
        // let user_id;
        // let advancedModeShown = false;
        // let submitShown = false;
        var selectedRow;
        var showSongs = true;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (accessToken) {
                // render oauth info
                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: accessToken,
                    refresh_token: refresh_token
                });
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    success: function (response) {
                        authResponse = response;
                        userId = response.id;
                        // $('#login').hide();
                        // $('#submitPlaylistForm').hide();
                        // $('#loggedin').show();

                        // Set up listeners
                        getStoredUserInfo(function (response) {
                            if (response) {
                                userProfile = response;
                                initLoggedIn();
                            } else {
                                $('#login').hide();
                                $('#submitPlaylistForm').hide();
                                $('#loggedin').hide();
                                $('#submit-bmi-container').show();
                                document.getElementById('submit-bmi').addEventListener('click', function () {
                                    const height = document.getElementById('user-height').value;
                                    const weight = document.getElementById('user-weight').value;
                                    const bmi = (weight / height / height) * 703;
                                    userProfile = {
                                        height: height,
                                        weight: weight,
                                        bmi: bmi
                                    };
                                    setStoredUserInfo(userProfile,
                                        function (response) {
                                            initLoggedIn();
                                        })
                                });
                            }
                        });
                    }
                });
            } else {
                // render initial screen
                $('#login').show();
                $('#submitPlaylistForm').hide();
                $('#loggedin').hide();
            }
            let obtainNewToken = function () {
                $.ajax({
                    url: '/api/refresh_token',
                    data: {
                        'refresh_token': refresh_token
                    }
                }).done(function (data) {
                    accessToken = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: accessToken,
                        refresh_token: refresh_token
                    });
                });
            };
            document.getElementById('obtain-new-token').addEventListener('click', obtainNewToken, false);

            function initLoggedIn() {
                $('#login').hide();
                $('#submitPlaylistForm').hide();
                $('#loggedin').show();
                $('#submit-bmi-container').hide();
                setGetUserPlaylistsListener();
                setCreateUserPlaylistsListener();
                setCreatePlaylistListener();
            }

            function toTitleCase(str) {
                return str.replace(/\w\S*/g, function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }

            function createElementFromHTML(htmlString) {
                let div = document.createElement('div');
                div.innerHTML = htmlString.trim();

                // Change this to div.childNodes to support multiple top-level nodes
                return div.firstChild;
            }

            function getStoredUserInfo(callback) {
                $.ajax({
                    url: '/api/stored-user-info/' + userId,
                    success: function (response) {
                        callback(response);
                    }
                });
            }

            function setStoredUserInfo(data, callback) {
                $.ajax({
                    type: 'POST',
                    url: '/api/stored-user-info/' + userId,
                    data: data,
                    success: function (response) {
                        if (callback) {
                            callback(response)
                        }
                    }
                });
            }

            function getUserPlaylists() {
                $.ajax({
                    url: '/api/playlist-list/' + userId + '?accessToken=' + accessToken,
                    success: function (response) {

                        var body = document.getElementsByTagName("body")[0];
                        var newRow = document.createElement("newRow");
                        // newRow.setAttribute("class", "row");
                        newRow.setAttribute("id", "elementsRow");

                        var div = document.createElement("div");
                        div.setAttribute("id", "viewPlaylistDiv");
                        div.setAttribute("class", "col-xs-5 col-sm-6 col-lg-4");
                        div.appendChild(newRow);

                        var newdiv = document.createElement("div");
                        newdiv.setAttribute("id", "graphsDiv");
                        newdiv.setAttribute("class", "col-xs-7 col-sm-6 col-lg-8");

                        newRow.appendChild(newdiv);
                        body.appendChild(div);

                        var tbl = document.createElement('table');
                        tbl.setAttribute('id', 'playlistTable');

                        div.appendChild(tbl);

                        tbl.setAttribute('class', 'playlistTable');

                        var tblBody = document.createElement('tbody');

                        for (var i = 0; i < response.length; i++) {
                            var row = document.createElement("tr");

                            var cell = document.createElement("td");
                            var cellText = document.createTextNode("- " + response[i]["name"]);

                            var cell2 = document.createElement("td");
                            var id = document.createTextNode(response[i]["id"]);

                            var cell3 = document.createElement("td");
                            var user = document.createTextNode(response[i]['ownerId']);

                            cell.appendChild(cellText);
                            cell2.appendChild(id);
                            cell3.appendChild(user);
                            cell2.setAttribute('hidden', 'true');
                            cell3.setAttribute('hidden', 'true');
                            row.appendChild(cell);
                            row.appendChild(cell2);
                            row.appendChild(cell3);
                            row.setAttribute('class', 'tableRow');

                            tblBody.appendChild(row);
                            row.addEventListener('click', function () {
                                if (document.getElementById('graphSVG') != null) {
                                    var pSVG = document.getElementById('graphSVG');
                                    pSVG.parentNode.removeChild(pSVG);
                                }
                                showSongs = !showSongs
                                displayPlaylistData(this); //show graph
                            })
                        }

                        // put the <tbody> in the <table>
                        tbl.appendChild(tblBody);
                        // appends <table> into <body>
                        //body.appendChild(tbl);
                        // sets the border attribute of tbl to 2;
                        tbl.setAttribute("border", "2");

                        div.appendChild(tbl);
                        body.appendChild(div);

                        displayPlaylistData(tbl.rows[0])

                    }
                });
            }

            // function addTableRows(row, songList) {
            //     var table = document.getElementById('playlistTable')
            //     for (var i = 0; i < table.rows.length; i++) {
            //         var curRow = table.rows[i]
            //         if (curRow == row) {
            //             for (var j = 0; j < songList.length; j++) {
            //                 var newRow = table.insertRow(i + j + 1)
            //                 var cell = document.createElement("td");
            //                 var cellText = document.createTextNode("-- " + songList[j]["name"]);
            //                 cell.appendChild(cellText)
            //                 newRow.appendChild(cell)
            //             }

            //         }
            //     }

            // }

            // function deleteTableRows(row, songList) {
            //     var table = document.getElementById('playlistTable')
            //     for (var i = 0; i < table.rows.length; i++) {
            //         var curRow = table.rows[i]
            //         if (curRow == row) {
            //             for (var j = 0; j < songList.length; j++) {
            //                 var newRow = table.deleteRow(i + 1)

            //             }

            //         }
            //     }

            // }

            // when select View Playlists
            function setGetUserPlaylistsListener() {
                document.getElementById("viewPlaylistButton").addEventListener("click", function () {
                    // if (document.getElementById('createPlaylistDiv') != null) {
                    //     var pDiv = document.getElementById('createPlaylistDiv');
                    //     if (pDiv != null) {
                    //         pDiv.parentNode.removeChild(pDiv);
                    //     }
                    // }
                    $('#createPlaylistDiv').hide();
                    $('#submitPlaylistForm').hide();
                    if ((document.getElementById('viewButton').className) == 'btn btn-success') {
                        getUserPlaylists();
                    }
                    document.getElementById("viewButton").className = 'btn btn-success disabled';
                    document.getElementById("createButton").className = 'btn btn-success';
                })
            }

            function setCreatePlaylistListener() {
                document.getElementById('create-playlist-button').addEventListener('click', function () {
                    const maxNumSongs = document.getElementById('maxNumSongs').value;
                    const exerciseType = document.getElementById('selected-exercise-type').value;
                    const playlistName = document.getElementById('newPlaylistName').value;

                    if (maxNumSongs > 0 && playlistName !== null && playlistName !== '') {
                        createPlaylist(userId, playlistName, exerciseType, maxNumSongs, function (response) {
                            // console.log(response);
                            $('#createPlaylistDiv').hide();
                            $('#submitPlaylistForm').hide();
                            if ((document.getElementById('viewButton').className) == 'btn btn-success') {
                                getUserPlaylists();
                            }
                            document.getElementById("viewButton").className = 'btn btn-success disabled';
                            document.getElementById("createButton").className = 'btn btn-success';

                            document.getElementById('maxNumSongs').value = null;
                            document.getElementById('newPlaylistName').value = null;
                        })
                    }

                });
            }

            function displayPlaylistData(element) {

                if (selectedRow != null) {
                    selectedRow.setAttribute('class', 'tableRow');
                }
                selectedRow = element;
                selectedRow.setAttribute('class', 'selectedRow');

                var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute('style', 'border: 1px grey');
                svg.setAttribute('width', '1500');
                svg.setAttribute('height', '2000');
                svg.setAttribute('id', 'graphSVG');

                var div = document.getElementById('graphsDiv');

                var tbl = document.createElement('table');
                tbl.setAttribute('id', 'summaryTable');

                div.appendChild(tbl);

                var tblBody = document.createElement('tbody');
                tblBody.setAttribute('id', 'tableBody');

                tbl.appendChild(tblBody)

                div.appendChild(svg);

                d3.json('/api/playlist-info/' + element.cells[2].innerHTML + '/' + element.cells[1].innerHTML + '?accessToken=' + accessToken, function (error, data) {
                    if (error) throw error;

                    var dataV = Object.values(data)
                    console.log(dataV)

                    var totCal = getTotalCalories(dataV)
                    var avgs = getAverages(dataV)
                    console.log(avgs)

                    var summaryRow = document.createElement("tr");
                    var summaryCell = document.createElement("td");
                    var summaryText = document.createTextNode("Playlist Summary:");
                    summaryCell.appendChild(summaryText)
                    summaryRow.appendChild(summaryCell)
                    tblBody.appendChild(summaryRow)

                    var calsRow = document.createElement("tr");
                    var calsCell = document.createElement("td");
                    var calsText = document.createTextNode("Total Calories Burned: " + totCal.toString() );
                    calsCell.appendChild(calsText)
                    calsRow.appendChild(calsCell)
                    tblBody.appendChild(calsRow)

                    var danceRow = document.createElement("tr");
                    var danceCell = document.createElement("td");
                    var danceText = document.createTextNode("Average Danceability: " + avgs['danceability'].toString());
                    danceCell.appendChild(danceText)
                    danceRow.appendChild(danceCell)
                    tblBody.appendChild(danceRow)

                    var valenceRow = document.createElement("tr");
                    var valenceCell = document.createElement("td");
                    var valenceText = document.createTextNode("Average Valence: "+ avgs['valence'].toString());
                    valenceCell.appendChild(valenceText)
                    valenceRow.appendChild(valenceCell)
                    tblBody.appendChild(valenceRow)

                    var energyRow = document.createElement("tr");
                    var energyCell = document.createElement("td");
                    var energyText = document.createTextNode("Average Energy: "+ avgs['energy'].toString());
                    energyCell.appendChild(energyText)
                    energyRow.appendChild(energyCell)
                    tblBody.appendChild(energyRow)

                    var tempoRow = document.createElement("tr");
                    var tempoCell = document.createElement("td");
                    var tempoText = document.createTextNode("Average Tempo: "+ avgs['tempo'].toString());
                    tempoCell.appendChild(tempoText)
                    tempoRow.appendChild(tempoCell)
                    tblBody.appendChild(tempoRow)

                    var intensityRow = document.createElement("tr");
                    var intensityCell = document.createElement("td");
                    var intensityText = document.createTextNode("Average Intensity: "+ avgs['intensity'].toString());
                    intensityCell.appendChild(intensityText)
                    intensityRow.appendChild(intensityCell)
                    tblBody.appendChild(intensityRow)

                    // if (showSongs) {
                    //     addTableRows(element, dataV)
                    // } else {
                    //     deleteTableRows(element, dataV)
                    // }

                    playlistData = dataV;

                    var svgD3 = d3.select('svg');

                    var exTypes = d3.nest()
                        .key(function(d) {return d['exercise-type'];})
                        .rollup(function(values) {return d3.sum(values, function() {return 1;})})
                        .entries(dataV);

                    var barYscale = d3.scaleLinear()
                        .domain([0,d3.max(exTypes, function(d) {return d.value;})])
                        .range([400,0])

                    var barXscale = d3.scaleOrdinal()
                        .domain(data.map(function(d) {return d['exercise-type'];}))
                        .range([75,235, 395])

                    var barXaxis = d3.axisBottom(barXscale).ticks(3);

                    var barYaxis = d3.axisLeft(barYscale).ticks(6);

                    svgD3.append('g')
                        .attr('class', 'yaxis')
                        .attr('transform', 'translate(50, 950)')
                        .attr('stroke', 'white')
                        .call(barYaxis);

                    svgD3.append('g')
                        .attr('class', 'barxaxis')
                        .attr('transform', 'translate(50, 1350)')
                        .attr('stroke', 'white')
                        .call(barXaxis);

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(20,1150)rotate(-90)')
                        .text('Number of Songs in Playlist')

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(300,1390)')
                        .text('Song Exercise Type')

                    svgD3.append('text')
                        .attr('class', 'title')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(300,940)')
                        .text('Song Suitability Breakdown')

                    svgD3.selectAll('rect')
                        .data(exTypes)
                        .enter()
                        .append('rect')
                        .attr('fill', function(d) {
                            if (d.key == 'Cardio') {
                                return '#30842e';
                            } else if (d.key == 'Yoga') {
                                return '#82D7E8';
                            }
                            return 'white';
                        })
                        .attr('transform', function(d, i) {return 'translate(' + (75 + i*160) + ',' + (950+ barYscale(d.value)) + ')';})
                        .attr('width', 100)
                        .attr('height', function(d) {return 400-barYscale(d.value);})


                    var maxDance = d3.max(dataV, function (d) {
                        return d.danceability;
                    })

                    var maxValence = d3.max(dataV, function (d) {
                        return d.valence;
                    })

                    var maxEnergy = d3.max(dataV, function (d) {
                        return d.energy;
                    })

                    var maxTempo = d3.max(dataV, function (d) {
                        return d.tempo;
                    })

                    var maxIntensity = d3.max(dataV, function (d) {
                        return d['exercise-intensity'];
                    })

                    var yscale1 = d3.scaleLinear()
                        .domain([0, d3.max([maxDance, maxValence, maxEnergy])])
                        .range([400, 0]);

                    var songNames = dataV.map(function (d) {
                        return d.name;
                    })

                    var xscale = d3.scaleLinear()
                        .domain([0, songNames.length])
                        .range([0, 1000])

                    var yscale2 = d3.scaleLinear()
                        .domain([0, d3.max([maxTempo, maxIntensity])])
                        .range([400, 0]);

                    var yAxis1 = d3.axisLeft(yscale1).ticks(11);

                    var yAxis2 = d3.axisLeft(yscale2).ticks(11);

                    var xAxis = d3.axisBottom(xscale).ticks(songNames.length).tickFormat("");

                    var xscale = d3.scaleLinear()
                        .domain([0, songNames.length])
                        .range([0, 1000])

                    var yscale2 = d3.scaleLinear()
                        .domain([0, d3.max(dataV, function (d) {
                            return d.tempo;
                        })])
                        .range([400, 0]);

                    var yAxis1 = d3.axisLeft(yscale1).ticks(11);

                    var yAxis2 = d3.axisLeft(yscale2).ticks(11);

                    var xAxis = d3.axisBottom(xscale).ticks(songNames.length).tickFormat("");

                    var danceLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.danceability);
                        });

                    var valenceLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.valence);
                        });

                    var energyLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.energy);
                        });

                    var tempoLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale2(d.tempo);
                        });

                    var intensityLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale2(d['exercise-intensity']);
                        });

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 100)
                        .attr('x2', 1090)
                        .attr('y2', 100)
                        .attr('stroke', 'white');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,105)')
                        .text('Danceability')

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 130)
                        .attr('x2', 1090)
                        .attr('y2', 130)
                        .attr('stroke', '#30842e');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,135)')
                        .text('Valence');

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 160)
                        .attr('x2', 1090)
                        .attr('y2', 160)
                        .attr('stroke', '#82D7E8');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,165)')
                        .text('Energy')


                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', 'white')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", danceLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#30842e')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", valenceLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#82D7E8')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", energyLine);

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 620)
                        .attr('x2', 1090)
                        .attr('y2', 620)
                        .attr('stroke', '#0066cc');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,625)')
                        .text('Tempo')

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 650)
                        .attr('x2', 1090)
                        .attr('y2', 650)
                        .attr('stroke', 'red');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,655)')
                        .text('Intensity')

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#0066cc')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 500)')
                        .attr("d", tempoLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', 'red')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 500)')
                        .attr("d", intensityLine);

                    svgD3.append('g')
                        .attr('class', 'yaxis')
                        .attr('transform', 'translate(50, 30)')
                        .style('stroke', 'white')
                        .call(yAxis1);


                    svgD3.append('g')
                        .attr('class', 'yaxis')
                        .attr('transform', 'translate(50, 500)')
                        .attr('stroke', 'white')
                        .call(yAxis2);

                    svgD3.append('g')
                        .attr('class', 'xaxis')
                        .attr('transform', 'translate(50, 430)')
                        .attr('stroke', 'white')
                        .call(xAxis);

                    svgD3.append('g')
                        .attr('class', 'xaxis')
                        .attr('transform', 'translate(50, 900)')
                        .attr('stroke', 'white')
                        .call(xAxis);

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(20,215)rotate(-90)')
                        .text('Danceability, Valence, and Energy')

                    svgD3.append('text')
                        .attr('class', 'title')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(550,20)')
                        .text('Danceability, Valence, and Energy By Song')

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(20,695)rotate(-90)')
                        .text('Tempo and Intensity')

                    svgD3.append('text')
                        .attr('class', 'title')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(550,490)')
                        .text('Tempo and Intensity By Song')

                })
            }

            // when you click Create Playlist
            function setCreateUserPlaylistsListener() {
                document.getElementById("createPlaylistButton").addEventListener("click", function () {
                    if ((document.getElementById('createButton').className) == 'btn btn-success') {
                        var pDiv = document.getElementById('viewPlaylistDiv');
                        if (pDiv != null) {
                            pDiv.parentNode.removeChild(pDiv);
                        }
                    }

                    var body = document.getElementsByTagName("body")[0];

                    var div = document.createElement('div');
                    div.setAttribute("id", "createPlaylistDiv");
                    showExerciseForm();

                    let form = document.getElementById("submitPlaylistForm");
                    div.appendChild(form);

                    body.appendChild(div)
                    document.getElementById("createButton").className = 'btn btn-success disabled';
                    document.getElementById("viewButton").className = 'btn btn-success';
                    var pDiv = document.getElementById('viewPlaylistDiv');
                    $('#viewPlaylistDiv').hide();
                })
            }

            function showExerciseForm() {
                $('#submitPlaylistForm').show();
                $('#loggedin').show();
                $('#login').hide();
            }

            function refreshPlaylistInfo(userId, playlistId) {
                $.ajax({
                    type: "POST",
                    url: '/api/refresh-playlist-info/',
                    data: {
                        'accessToken': accessToken,
                        'userId': userId,
                        'playlistID': playlistId
                    },
                    success: function (response) {
                        console.log(response)
                    }
                });
            }

            function getPlaylistInfo(userId, playlistId, callback) {
                $.ajax({
                    type: "GET",
                    url: '/api/playlist-info/' + userId + '/' + playlistId + '?accessToken=' + accessToken,
                    success: function (response) {
                        callback(response)
                    }
                });
            }

            function getTotalCalories(songList) {
                let result = [];
                for (let i = 0; i < songList.length; i++) {
                    const song = songList[i];
                    const weightKil = userProfile.weight / 2.2;
                    const durationSeconds = song['duration-ms'] / 1000;
                    let metValue = 10;
                    const type = song['exercise-type'];
                    if (type === 'Yoga') {
                        metValue = 3;
                    } else if (type === 'Cardio') {
                        metValue = 7;
                    }
                    const songCalories = weightKil * metValue * durationSeconds / 3600;
                    result.push(songCalories);
                }
                return result.reduce(add, 0);
            }

            function add(a, b) {
                return a + b;
            }

            function getAverages(songList) {
                var result = {};
                var dance = 0.0;
                var valence = 0.0;
                var tempo = 0.0;
                var energy = 0.0;
                var intensity = 0.0;
                for (var i = 0; i < songList.length; i++) {
                    var song = songList[i];
                    dance = dance + song['danceability'];
                    valence = valence + song['valence'];
                    tempo = tempo + song['tempo'];
                    energy = energy + song['energy'];
                    intensity = intensity + song['exercise-intensity'];
                }
                dance = dance/songList.length;
                valence = valence/songList.length;
                energy = energy/songList.length;
                tempo = tempo/songList.length;
                intensity = intensity/songList.length;
                result['danceability'] = dance;
                result['valence'] = valence;
                result['tempo'] = tempo;
                result['energy'] = energy;
                result['intensity'] = intensity;
                return result;
            }

            function createPlaylist(userId, playlistName, exerciseType, maxSongs, callback) {
                $.ajax({
                    type: "POST",
                    url: '/api/create-playlist/',
                    data: {
                        'accessToken': accessToken,
                        'userId': userId,
                        'playlistName': playlistName,
                        'exerciseType': exerciseType,
                        'maxSongs': maxSongs
                    },
                    success: function (response) {
                        if (callback) {
                            callback(response)
                        }
                    }
                });
            }
        }
    })();

</script>
</body>
</html>
