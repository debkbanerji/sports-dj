<!doctype html>
<html>
<head>
    <title>Sports DJ</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--Import Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <meta property="og:title" content="Sports DJ"/>
    <meta property="og:description"
          content="Visualizing workout based music data"/>
    <meta property="og:image" content="placeholder"/>

    <link rel="icon" type="image/x-icon" href="assets/ico/favicon.ico?v=2">
    <script src="https://use.fontawesome.com/287f0668e1.js"></script>
    <link href="https://use.fontawesome.com/287f0668e1.css" media="all" rel="stylesheet">
    <style type="text/css">
        #login, #loggedin, #submitPlaylistForm, #submit-bmi-container {
            display: none;
        }
    </style>
    <div>
        <center><img src="assets/png/sportsdj.png"></center>
    </div>

</head>

<body class="page">
<div class="container">
    <div id="login">
        <br>
        <center>
            <div class="container-fluid-landing">
                <div id="blurb">Be your own workout DJ!<br>Log in with your Spotify account
                    to select a playlist and analyze how well it fits specific exercises.
                </div>
                <br>
                <br><a href="/api/login" class="text-center btn" id="spotify-button">Log in with <i
                    class="fa fa-spotify" aria-hidden="true"></i>
                Spotify</a>
            </div>
        </center>
    </div>
</div>
<div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>
    <button hidden data-toggle="collapse" data-target="#collapse-div">Collapsible</button>
    <div class="collapse" id="collapse-div">
        <button hidden class=" btn btn-default" id="obtain-new-token">Obtain new token using the refresh token
        </button>
    </div>
    <br>
    <div class="row" id="buttonsRow">
        <div id="viewPlaylistButton" class="col-sm">
            <button type="button" class="btn btn-success" id="viewButton">View Playlists</button>
        </div>
        <div id="createPlaylistButton" class="col-sm">
            <button type="button" class="btn btn-success" id="createButton">Create Playlist</button>
        </div>
    </div>
    <br>

</div> <!-- end of loggedin -->

<div id="submitPlaylistForm">
    <form class="form-horizontal" action="/action_page.php">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Exercise Type
                <span class="caret"></span></button>
            <ul class="dropdown-menu">
                <li>Strength</li>
                <li>Cardio</li>
                <li>Yoga</li>
            </ul>
        </div>
        <div class="form-group">
            <label class="control-label col-sm" for="numSongs">Number of Songs</label>
            <div class="col-sm-10">
                <input type="numSongs" class="form-control" id="numSongs" placeholder="Enter number of songs"
                       name="numSongs">
            </div>
        </div>
        <br>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default">Submit</button>
            </div>
        </div>
    </form>
</div>

<div id="submit-bmi-container" class="container">
    <br>
    <center>
        <div class="container-fluid-landing">
            <br>
            <input id="user-height" placeholder="height (inches)" type="number">
            <input id="user-weight" placeholder="weight (pounds)" type="number">
            <a class="text-center btn btn btn-success" id="submit-bmi">
                Submit
            </a>
        </div>
    </center>
</div>

<script id="oauth-template" type="text/x-handlebars-template">
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script>
    (function () {
        var authResponse;

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');
        var params = getHashParams();
        var accessToken = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;
        var userId;
        let user_id;
        let advancedModeShown = false;
        let submitShown = false;
        var selectedRow;
        var showSongs = true;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (accessToken) {
                // render oauth info
                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: accessToken,
                    refresh_token: refresh_token
                });
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    },
                    success: function (response) {
                        authResponse = response;
                        userId = response.id;
                        // $('#login').hide();
                        // $('#submitPlaylistForm').hide();
                        // $('#loggedin').show();

                        // Set up listeners
                        getStoredUserInfo(function (response) {
                            if (response) {
                                initLoggedIn();
                            } else {
                                $('#login').hide();
                                $('#submitPlaylistForm').hide();
                                $('#loggedin').hide();
                                $('#submit-bmi-container').show();
                                document.getElementById('submit-bmi').addEventListener('click', function () {
                                    const height = document.getElementById('user-height').value;
                                    const weight = document.getElementById('user-weight').value;
                                    const bmi = (weight / height / height) * 703
                                    setStoredUserInfo({
                                        height: height,
                                        weight: weight,
                                        bmi: bmi
                                    }, function (response) {
                                        initLoggedIn();
                                    })
                                });
                            }
                        });
                    }
                });
            } else {
                // render initial screen
                $('#login').show();
                $('#submitPlaylistForm').hide();
                $('#loggedin').hide();
            }
            let obtainNewToken = function () {
                $.ajax({
                    url: '/api/refresh_token',
                    data: {
                        'refresh_token': refresh_token
                    }
                }).done(function (data) {
                    accessToken = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: accessToken,
                        refresh_token: refresh_token
                    });
                });
            };
            document.getElementById('obtain-new-token').addEventListener('click', obtainNewToken, false);

            function initLoggedIn() {
                $('#login').hide();
                $('#submitPlaylistForm').hide();
                $('#loggedin').show();
                $('#submit-bmi-container').hide();
                setGetUserPlaylistsListener();
                setCreateUserPlaylistsListener();
            }

            function toTitleCase(str) {
                return str.replace(/\w\S*/g, function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }

            function createElementFromHTML(htmlString) {
                let div = document.createElement('div');
                div.innerHTML = htmlString.trim();

                // Change this to div.childNodes to support multiple top-level nodes
                return div.firstChild;
            }

            function getStoredUserInfo(callback) {
                $.ajax({
                    url: '/api/stored-user-info/' + userId,
                    success: function (response) {
                        callback(response);
                        console.log('response', response);
                    }
                });
            }

            function setStoredUserInfo(data, callback) {
                $.ajax({
                    type: 'POST',
                    url: '/api/stored-user-info/' + userId,
                    data: data,
                    success: function (response) {
                        if (callback) {
                            callback(response)
                        }
                    }
                });
            }

            function getUserPlaylists() {
                $.ajax({
                    url: '/api/playlist-list/' + userId + '?accessToken=' + accessToken,
                    success: function (response) {

                        var body = document.getElementsByTagName("body")[0];
                        var newRow = document.createElement("newRow");
                        // newRow.setAttribute("class", "row");
                        newRow.setAttribute("id", "elementsRow");

                        var div = document.createElement("div");
                        div.setAttribute("id", "viewPlaylistDiv");
                        div.setAttribute("class", "col-xs-5 col-sm-6 col-lg-4");
                        div.appendChild(newRow);

                        var newdiv = document.createElement("div");
                        newdiv.setAttribute("id", "graphsDiv");
                        newdiv.setAttribute("class", "col-xs-7 col-sm-6 col-lg-8");

                        newRow.appendChild(newdiv);
                        body.appendChild(div);

                        var tbl = document.createElement('table');
                        tbl.setAttribute('id', 'playlistTable')

                        div.appendChild(tbl);

                        tbl.setAttribute('class', 'playlistTable');

                        var tblBody = document.createElement('tbody');

                        for (var i = 0; i < response.length; i++) {
                            var row = document.createElement("tr");

                            var cell = document.createElement("td");
                            var cellText = document.createTextNode("- " + response[i]["name"]);

                            var cell2 = document.createElement("td");
                            var id = document.createTextNode(response[i]["id"]);

                            var cell3 = document.createElement("td");
                            var user = document.createTextNode(response[i]['ownerId']);

                            cell.appendChild(cellText);
                            cell2.appendChild(id);
                            cell3.appendChild(user);
                            cell2.setAttribute('hidden', 'true');
                            cell3.setAttribute('hidden', 'true');
                            row.appendChild(cell);
                            row.appendChild(cell2);
                            row.appendChild(cell3);
                            row.setAttribute('class', 'tableRow');

                            tblBody.appendChild(row);
                            row.addEventListener('click', function () {
                                if (document.getElementById('graphSVG') != null) {
                                    var pSVG = document.getElementById('graphSVG');
                                    pSVG.parentNode.removeChild(pSVG);
                                }
                                showSongs = !showSongs
                                displayPlaylistData(this); //show graph
                            })
                        }

                        // put the <tbody> in the <table>
                        tbl.appendChild(tblBody);
                        // appends <table> into <body>
                        //body.appendChild(tbl);
                        // sets the border attribute of tbl to 2;
                        tbl.setAttribute("border", "2");

                        div.appendChild(tbl);
                        body.appendChild(div)

                        displayPlaylistData(tbl.rows[0])

                    }
                });
            }

            // function addTableRows(row, songList) {
            //     var table = document.getElementById('playlistTable')
            //     for (var i = 0; i < table.rows.length; i++) {
            //         var curRow = table.rows[i]
            //         if (curRow == row) {
            //             for (var j = 0; j < songList.length; j++) {
            //                 var newRow = table.insertRow(i + j + 1)
            //                 var cell = document.createElement("td");
            //                 var cellText = document.createTextNode("-- " + songList[j]["name"]);
            //                 cell.appendChild(cellText)
            //                 newRow.appendChild(cell)
            //             }
                        
            //         }
            //     }

            // }

            // function deleteTableRows(row, songList) {
            //     var table = document.getElementById('playlistTable')
            //     for (var i = 0; i < table.rows.length; i++) {
            //         var curRow = table.rows[i]
            //         if (curRow == row) {
            //             for (var j = 0; j < songList.length; j++) {
            //                 var newRow = table.deleteRow(i + 1)
                            
            //             }
                        
            //         }
            //     }

            // }

            // when select View Playlists
            function setGetUserPlaylistsListener() {
                document.getElementById("viewPlaylistButton").addEventListener("click", function () {
                    if (document.getElementById('createPlaylistDiv') != null) {
                        var pDiv = document.getElementById('createPlaylistDiv');
                        if (pDiv != null) {
                            pDiv.parentNode.removeChild(pDiv);
                        }
                    }
                    if ((document.getElementById('viewButton').className) == 'btn btn-success') {
                        getUserPlaylists();
                    }
                    document.getElementById("viewButton").className = 'btn btn-success disabled';
                    document.getElementById("createButton").className = 'btn btn-success';
                })
            }

            function displayPlaylistData(element) {
                
                if (selectedRow != null) {
                    selectedRow.setAttribute('class', 'tableRow');
                }
                selectedRow = element;
                selectedRow.setAttribute('class', 'selectedRow');

                var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute('style', 'border: 1px grey');
                svg.setAttribute('width', '1500');
                svg.setAttribute('height', '2000');
                svg.setAttribute('id', 'graphSVG');

                var div = document.getElementById('graphsDiv');

                div.appendChild(svg)

                d3.json('/api/playlist-info/' + element.cells[2].innerHTML + '/' + element.cells[1].innerHTML + '?accessToken=' + accessToken, function (error, data) {
                    if (error) throw error;

                    var dataV = Object.values(data)

                    // if (showSongs) {
                    //     addTableRows(element, dataV)
                    // } else {
                    //     deleteTableRows(element, dataV)
                    // }

                    console.log(dataV)

                    playlistData = dataV;

                    var svgD3 = d3.select('svg');

                    var maxDance = d3.max(dataV, function (d) {
                        return d.danceability;
                    })

                    var maxValence = d3.max(dataV, function (d) {
                        return d.valence;
                    })

                    var maxEnergy = d3.max(dataV, function (d) {
                        return d.energy;
                    })

                    var yscale1 = d3.scaleLinear()
                        .domain([0, d3.max([maxDance, maxValence, maxEnergy])])
                        .range([400, 0]);

                    var songNames = dataV.map(function (d) {
                        return d.name;
                    })

                    var xscale = d3.scaleLinear()
                        .domain([0, songNames.length])
                        .range([0, 1000])

                    var yscale2 = d3.scaleLinear()
                        .domain([0, d3.max(dataV, function (d) {
                            return d.tempo;
                        })])
                        .range([400, 0]);

                    var yAxis1 = d3.axisLeft(yscale1).ticks(11);

                    var yAxis2 = d3.axisLeft(yscale2).ticks(11);

                    var xAxis = d3.axisBottom(xscale).ticks(songNames.length).tickFormat("");

                    var xscale = d3.scaleLinear()
                        .domain([0, songNames.length])
                        .range([0, 1000])

                    var yscale2 = d3.scaleLinear()
                        .domain([0, d3.max(dataV, function (d) {
                            return d.tempo;
                        })])
                        .range([400, 0]);

                    var yAxis1 = d3.axisLeft(yscale1).ticks(11);

                    var yAxis2 = d3.axisLeft(yscale2).ticks(11);

                    var xAxis = d3.axisBottom(xscale).ticks(songNames.length).tickFormat("");

                    var danceLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.danceability);
                        });

                    var valenceLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.valence);
                        });

                    var energyLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale1(d.energy);
                        });

                    var tempoLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale2(d.tempo);
                        });

                    var intensityLine = d3.line()
                        .x(function (d, i) {
                            return xscale(i) + 50;
                        })
                        .y(function (d) {
                            return yscale2(d['exercise-intensity']);
                        });

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 100)
                        .attr('x2', 1090)
                        .attr('y2', 100)
                        .attr('stroke', 'white');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,105)')
                        .text('Danceability')

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 130)
                        .attr('x2', 1090)
                        .attr('y2', 130)
                        .attr('stroke', '#30842e');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,135)')
                        .text('Valence')

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 160)
                        .attr('x2', 1090)
                        .attr('y2', 160)
                        .attr('stroke', '#82D7E8');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,165)')
                        .text('Energy')


                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', 'white')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", danceLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#30842e')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", valenceLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#82D7E8')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 30)')
                        .attr("d", energyLine);

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 620)
                        .attr('x2', 1090)
                        .attr('y2', 620)
                        .attr('stroke', '#0066cc');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,625)')
                        .text('Tempo')

                    svgD3.append('line')
                        .attr('x1', 1070)
                        .attr('y1', 650)
                        .attr('x2', 1090)
                        .attr('y2', 650)
                        .attr('stroke', 'red');

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'left')
                        .attr('transform', 'translate(1100,655)')
                        .text('Intensity')

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', '#0066cc')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 500)')
                        .attr("d", tempoLine);

                    svgD3.append("path")
                        .data([dataV])
                        .attr("class", "line")
                        .attr('stroke', 'red')
                        .attr('fill', 'none')
                        .attr('transform', 'translate(0, 500)')
                        .attr("d", intensityLine);

                    svgD3.append('g')
                        .attr('class', 'yaxis')
                        .attr('transform', 'translate(50, 30)')
                        .style('stroke', 'white')
                        .call(yAxis1);


                    svgD3.append('g')
                        .attr('class', 'yaxis')
                        .attr('transform', 'translate(50, 500)')
                        .attr('stroke', 'white')
                        .call(yAxis2);

                    svgD3.append('g')
                        .attr('class', 'xaxis')
                        .attr('transform', 'translate(50, 430)')
                        .attr('stroke', 'white')
                        .call(xAxis);

                    svgD3.append('g')
                        .attr('class', 'xaxis')
                        .attr('transform', 'translate(50, 900)')
                        .attr('stroke', 'white')
                        .call(xAxis);

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(20,215)rotate(-90)')
                        .text('Danceability, Valence, and Energy')

                    svgD3.append('text')
                        .attr('class', 'title')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(550,20)')
                        .text('Danceability, Valence, and Energy By Song')

                    svgD3.append('text')
                        .attr('class', 'text')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(20,695)rotate(-90)')
                        .text('Tempo and Intensity')

                    svgD3.append('text')
                        .attr('class', 'title')
                        .attr('text-anchor', 'middle')
                        .attr('transform', 'translate(550,490)')
                        .text('Tempo and Intensity By Song')

                })
            }

            // when you click Create Playlist
            function setCreateUserPlaylistsListener() {
                document.getElementById("createPlaylistButton").addEventListener("click", function () {
                    if ((document.getElementById('createButton').className) == 'btn btn-success') {
                        var pDiv = document.getElementById('viewPlaylistDiv');
                        if (pDiv != null) {
                            pDiv.parentNode.removeChild(pDiv);
                        }
                    }

                    var body = document.getElementsByTagName("body")[0];

                    var div = document.createElement('div');
                    div.setAttribute("id", "createPlaylistDiv");
                    showExerciseForm();

                    form = document.getElementById("submitPlaylistForm");
                    div.appendChild(form);

                    body.appendChild(div)
                    document.getElementById("createButton").className = 'btn btn-success disabled';
                    document.getElementById("viewButton").className = 'btn btn-success';

                })
            }

            function showExerciseForm() {
                $('#submitPlaylistForm').show();
                $('#loggedin').show();
                $('#login').hide();
            }

            function refreshPlaylistInfo(userId, playlistId) {
                $.ajax({
                    type: "POST",
                    url: '/api/refresh-playlist-info/',
                    data: {
                        'accessToken': accessToken,
                        'userId': userId,
                        'playlistID': playlistId
                    },
                    success: function (response) {
                        console.log(response)
                    }
                });
            }

            function getPlaylistInfo(userId, playlistId, callback) {
                $.ajax({
                    type: "GET",
                    url: '/api/playlist-info/' + userId + '/' + playlistId + '?accessToken=' + accessToken,
                    success: function (response) {
                        callback(response)
                    }
                });
            }

            function createPlaylist(userId, playlistName, exerciseType, maxSongs, callback) {
                $.ajax({
                    type: "POST",
                    url: '/api/create-playlist/',
                    data: {
                        'accessToken': accessToken,
                        'userId': userId,
                        'playlistName': playlistName,
                        'exerciseType': exerciseType,
                        'maxSongs': maxSongs
                    },
                    success: function (response) {
                        if (callback) {
                            callback(response)
                        }
                    }
                });
            }
        }
    })();

</script>
</body>
</html>
